<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fastpen : a client side only codepen alternative</title>
  </head>

  <body>
    <div id="split">
      <textarea id="editor"></textarea>
      <iframe srcdoc="" id="preview"></iframe>
    </div>
    <script>
      const defaultContent =
        "<p>Add some html code here</p>\n\n" +
        "<script>\n/*Maybe some javascript ? */\n\n</sc" +
        "ript>\n<style>\n/*How about some css to make it look nice ? */\n\n</style>";

      const editor = document.getElementById("editor");
      const preview = document.getElementById("preview");


      function onCodeChange() {
      	updatePreview()
		updateURL()
      }

      function updatePreview() {
        preview.srcdoc = `<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"></head><body>${editor.value}</body></html>`;

      }
 
      function updateURL() { 
      	const uncompressed=editor.value
      	compress(uncompressed).then(compressed=>{
      		if(uncompressed==editor.value)
	      		history.replaceState(
	  	          compressed,
	  	          "",
	  	          "?src=" + encodeURIComponent(compressed),
	  	        )
	      	console.log(encodeURIComponent(uncompressed).length +' to '+encodeURIComponent(compressed).length)
      	}) 
      }

      editor.addEventListener("keyup", onCodeChange);
      editor.addEventListener("change", onCodeChange);

      editor.style.width = (localStorage.getItem("ta-size") || window.innerWidth/2) + "px";
  
      new ResizeObserver(()=>localStorage.setItem("ta-size", editor.scrollWidth)).observe(editor);

      async function compress(str) {
	  // Convert the string to a byte stream.
	  const stream = new Blob([str]).stream();

	  // Create a compressed stream.
	  const compressedStream = stream.pipeThrough(
	    new CompressionStream("gzip")
	  );

	  // Read all the bytes from this stream.
	  const chunks = [];
	  for await (const chunk of compressedStream) {
	    chunks.push(chunk);
	  }

	const u8= await concatUint8Arrays(chunks);
	var b64encoded = btoa(String.fromCharCode.apply(null, u8));

	return b64encoded

	}


	async function concatUint8Arrays(uint8arrays) {
  const blob = new Blob(uint8arrays);
  const buffer = await blob.arrayBuffer();
  return new Uint8Array(buffer);
}

async function decompress(b64encoded) {
  const compressedBytes = new Uint8Array(atob(b64encoded).split("").map(function(c) {
    return c.charCodeAt(0); }));

  // Convert the bytes to a stream.
  const stream = new Blob([compressedBytes]).stream();

  // Create a decompressed stream.
  const decompressedStream = stream.pipeThrough(
    new DecompressionStream("gzip")
  );

  // Read all the bytes from this stream.
  const chunks = [];
  for await (const chunk of decompressedStream) {
    chunks.push(chunk);
  }
  const stringBytes = await concatUint8Arrays(chunks);

  // Convert the bytes to a string.
  return new TextDecoder().decode(stringBytes);
}		
      if(window.location.search){
		editor.value = 'Decompressing...'
		editor.disabled=true
		const decoded=decodeURIComponent(window.location.search?.replace(/^\?src=/,'')) 
		decompress(decoded).then(source=>{
			editor.disabled=false
			editor.value=source
			updatePreview()
		}, error=>{
			editor.disabled=false
			editor.value=error.message
			updatePreview()
			console.error(error)
		})
      }else{
		editor.value = defaultContent
      	updatePreview();
      } 
      
    </script>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      * {
        box-sizing: border-box;
      }
      #split {
        display: flex;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
      }
      #editor {
        resize: horizontal;
        flex-grow: 0;
        flex-shrink: 0;
        box-shadow: 5px 5px 5px rgba(0, 0, 0, 0.1) inset;
        border: none;
        padding: 20px;
        line-height: 20px;
        background: #333;
        color: white;
        font-family: monospace;
        max-width: 80%;
      }
      #preview {
        flex-grow: 1;
        flex-shrink: 1;
        border: none;
        box-shadow: 5px 5px 5px rgba(0, 0, 0, 0.1) inset;
        overflow: hidden;
      }

    </style>
  </body>
</html>
